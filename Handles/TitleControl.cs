using Horizon.PackageEditors.Motorcross_Madness;
using XContent;

namespace Horizon
{
    internal static class FormID
    {
        internal const string
            AlanWake = "4D530805",
            Alice = "45410916",
            AssassinsCreed = "555307D4",
            ACRevelations = "55530879",
            AssassinsCreedII = "5553083B",
            AssassinsCreedIII = "555308AE",
            AssassinsCreedIV = "555308C2",
            AssassinsCreedRogue = "555308CE",
            AssassinsCreedBrotherhood = "5553085D",
            Bastion = "58410B66",
            BatmanArkhamCity = "57520802",
            Battlefield4 = "454109BA",
            BattlefieldBC2 = "454108A8",
            BattleBlockTheater = "58410A30",
            Bayonetta = "53450813",
            BionicCommando = "434307DD",
            BioShock = "545407D8",
            Bioshock2 = "54540861",
            BioshockInfinite = "5454085D",
            Borderlands = "545407E7",
            Brink = "425307D9",
            BrutalLegend = "454108C5",
            Bulletstorm = "454108EF",
            CallofDutyGhosts = "415608FC",
            CallofDutyAdvancedWarfare = "41560914",
            CaptainAmerica = "53450858",
            CastleCrashers = "584108B7",
            Crackdown = "4D5307DC",
            Crackdown2 = "4D5308BC",
            Crysis2Campaign = "454108EU",
            Crysis2Profile = "454108E3",
            Crysis2Save = "454108EX",
            Crysis3SaveGame = "4541098E",
            Darksiders = "545107E6",
            DeadRising2 = "434307EC",
            DeadSpace = "45410857",
            DeadSpace2 = "454108DF",
            DeadSpace3 = "4541099D",
            DevilMayCry = "43430824",
            DMC3 = "4343081E",
            DevilMayCry4 = "434307DF",
            Diablo3 = "394F07D1",
            Dirt2 = "434D0819",
            Dirt3 = "434D083D",
            DirtShowdown = "434D0845",
            Dishonored = "425307E3",
            DragonballXenoVerse ="4E4D0862",
            DragonsDogma = "43430814",
            Fable2 = "4D5307F1",
            FarCry3 = "5553088C",
            FarCry4 = "555308CA",
            FarCry3BloodDragon = "584113BF",
            FEAR = "565507D9",
            FEAR2 = "575207D3",
            FEAR3_SaveEditor = "57520800",
            FIFA11 = "454108F3",
            FIFA12 = "45410967",
            FIFA13 = "45410998",
            FIFA14 = "454109C3",
            FIFA15 = "454109DB",
            Forza3 = "4D53084D",
            Forza3Liveries = "4D53084U",
            Forza3SS = "4D53084X",
            Forza4Livery = "4D53091U",
            Forza4Profile = "4D530910",
            Forza4Ss = "4D53091P",
            ForzaHorizonLivery = "4D5309CU",
            ForzaHorizonProfile = "4D5309C9",
            ForzaHorizonSS = "4D5309CX",
            ForzaHorizon2Profile = "4D530AA4",
            ForzaHorizon2FnFProfile = "4D530AB5",
            ForzaHorizon2Livery = "4D530AAU",
            ForzaHorizon2SS = "4D530AAX",
            GearsOfWar = "4D5307D5",
            GearsOfWar2 = "4D53082D",
            GearsOfWar3 = "4D5308AB",
            GearsOfWar3PlayerData = "4D5308AX",
            GearsOfWar3ProfileData = "4D5308AP",
            GearsOfWarJudgment = "4D530A26",
            GearsOfWarJudgmentProfileEditor = "4D530A2X",
            GearsOfWarJudgmentStatsEditor = "4D530A2Z",
            GrandTheftAutoIV = "545407F2",
            GrandTheftAutoV = "545408A7",
            Grid2 = "434D0844",
            Halo3 = "4D5307E6",
            Halo3ODST = "4D530877",
            H4MegaloEditor = "4D53091M",
            Halo4Profile = "4D53091X",
            Halo4CampaignEditor = "4D530919",
            HaloAnniversary = "4D5309B1",
            HReachMegaloEditor = "4D53085M",
            HaloReach = "4D53085B",
            HaloReachSettings = "4D53085X",
            Homefront = "54510846",
            InjusticeGodsAmongUs = "57520829",
            JoeDangerSE = "584111F5",
            JustCause2 = "534307E7",
            LANoire = "5454086C",
            Left4Dead2 = "454108D4",
            LIMBO = "584109D1",
            LostOdyssey = "4D5307FA",
            Magic2013 = "58411213",
            MarbleBlastUltra = "584107D7",
            MaxPayne3 = "5454086B",
            MedalOfHonor = "454108F7",
            MercuryHg = "58410B8B",
            Metro2033 = "54510842",
            MetroLastLight = "4B4D07F5",
            MidnightClubLA = "545407F8",            
            MotocrossMadness = "58410B0F",
            MLB2K13 = "545408AB",
            MW3CampaignSave = "415608CB",
            NarutoUltimateNinjaStorm2 = "4E4D0819",
            NarutoUNS3 = "4E4D085C",
            NaughtyBear = "464F07D8",
            NBA2K13 = "545408A2",
            NBA2K14 = "545408B0",
            NBA2K15 = "545408B5",
            NeedForSpeedHP = "45410903",
            NHL12_CardEditor = "45410964",
            NinjaGaiden3RE = "4B5607E4",
            NPlus = "5841085C",
            Oblivion = "425307D1",
            PlantsvsZombies = "584109FF",
            ProfileDataEditor = "PROFILE",
            ProjectGothamRacing4 = "4D5307F9",
            QuakeArenaArcade = "584108C8",
            RageSave = "425307EC",
            RedDeadRedemption = "5454082B",
            RedFactionGuerrilla = "5451080D",
            ResidentEvil5 = "434307D4",
            ResidentEvil6 = "43430819",
            ResidentEvil_ORC = "4343081D",
            ResidetEvil_CVX = "43430822",
            SaintsRow3 = "5451086D",
            SaintsRow4 = "4B4D07F6",
            SaintsRowGOOH = "4B4D0800",          
            Shadows_of_the_Damned = "4541092A",
            SleepingDogs = "53510811",
            Skyrim = "425307E6",
            StateofDecay = "584111E8",
            SonicTheHedgehog = "534507D6",
            SSXTricky = "4541096D",
            StarWarsTFUII = "4C4107F2",
            SuperMeatBoy = "58410A5A",
            Swarm = "58410B07",
            TestDriveUnlimited = "494707D4",
            TestDriveUnlimited2 = "49470804",
            Saboteur = "4541088F",
            TigerWoodsPGATour14 = "454109A9",
            TombRaider = "53510802",
            WatchDogs = "555308B7",
            WET = "425307DB",
            Prototype = "4156084E",
            YuGiOh5Ds = "58410A03",
            YuGiOhMD = "58411442",
            ProfileEditor = "PROFILE",
            GameAdder = "ADDER",
            AchievementUnlocker = "UNLOCKER",
            AvatarAwardUnlocker = "AWARD",
            AvatarColorEditor = "AVATAR",
            AccountEditor = "ACCOUNT",
            TitleIDFinder = "TITLEID",
            ThemeCreator = "THEME",
            PackageManager = "PACKAGE",
            FATX = "FATX",
            GamercardViewer = "GCARD",
            GamerPictureManager = "GAMERPIC",
            TitleSettingsManager = "SETTINGS",
            TitleCrawler = "HELPER",
            Visit = "VISIT",
            About = "ABOUT";
    }

    internal static class TitleControl
    {
        private static readonly uint[] EffectedTitleIDs = 
        {
            0x415608FC, // Call of Duty Ghosts
            0x4D53082D, // Gears of War 2
            0x454108F3, // FIFA Soccer 11
            0x45410967, // FIFA Soccer 12
            0x45410998, // FIFA Soccer 13
            0x454109C3, // FIFA Soccer 14
            0x454109DB, // FIFA Soccer 15
            0x4D5307E6, // Halo 3
            0x4D530877, // Halo 3: ODST
            0x4D53085B, // Halo Reach
            0x4D530919, // Halo 4
            0x54510842, // Metro 2033
            0x4D53084D, // Forza 3
            0x45410916, // Alice: Madness Returns
            0x4D5308AB, // Gears of War 3
            0x4D530A26, // Gears of War Judgment
            0x4D530910, // Forza 4
            0x4D5309C9, // Forza Horizon
            0x4D530AA4, // Forza Horizon 2
            0x415608CB, // Modern Warfare 3
            0x4541096D, // SSX Tricky
            0x545408A2, // NBA 2K13
            0x45410959, // Dead Space 2 (German)
            0x545408AB, // MLB 2K13
        };

        internal static bool IsEffected(uint titleId)
        {
            foreach (uint effectedId in EffectedTitleIDs)
                if (effectedId == titleId)
                    return true;
            return false;
        }

        internal static string GetProperTitleIDForGpd(string formId)
        {
            switch (formId)
            {
                case "4D53091X":
                case "4D53091M":
                case "4D53091P":
                    return "4D530919";
                case "4D53085M":
                case "4D53085X":
                    return "4D53085B";
                case "4D5308AP":
                    return "4D5308AB";
                case "4D530A2X":
                    return "4D530A26";
                default:
                    return formId;
            }
        }

        private static byte FormIDToMetaIndex(string FID)
        {
            for (byte x = 0; x < FormConfig.formList.Count; x++)
                if (FormConfig.formList[x].ID == FID)
                    return x;
            return 255;
        }

        internal static bool ValidSaveGamePackage(XContentPackage Package)
        {
            return ValidSaveGamePackage(Package, GetProperTitleID(Package));
        }

        internal static bool ValidSaveGamePackage(XContentPackage Package, uint titleId)
        {
            byte temp = 0;
            return ValidSaveGamePackage(Package, titleId, ref temp);
        }

        internal static bool ValidSaveGamePackage(XContentPackage Package, uint titleId, ref byte metaIndex)
        {
            switch (titleId)
            {
                    // Call of Duty Ghosts
                case 0x415608FC:
                    return PackageContainsFile(Package, "savegame.svg");

                // Dead Space 2 (German)
                case 0x45410959:
                    metaIndex = FormIDToMetaIndex(FormID.DeadSpace2);
                    return true;

                // Gears of War 2
                case 0x4D53082D:
                    for (int x = 0; x < Package.StfsContentPackage.DirectoryEntries.Count; x++)
                        if (Package.StfsContentPackage.DirectoryEntries[x].FileName.Length > 16
                            && Package.StfsContentPackage.DirectoryEntries[x].FileName.Substring(0, 16) == "Gears2Checkpoint")
                            return true;
                    return false;

                // FIFA 11
                case 0x454108F3:
                    string fileName = Package.StfsContentPackage.DirectoryEntries[0].FileName;
                    return fileName.Length >= 8 && fileName.Substring(0, 8) == "Settings";

                // FIFA 12
                case 0x45410967:
                    fileName = Package.StfsContentPackage.DirectoryEntries[0].FileName;
                    return fileName.Length >= 8 && fileName.Substring(0, 8) == "Settings";
                // FIFA 13
                case 0x45410998:
                    fileName = Package.StfsContentPackage.DirectoryEntries[0].FileName;
                    return fileName.Length >= 6 && fileName.Substring(0, 6) == "Career";
                // FIFA 14
                case 0x454109C3:
                    fileName = Package.StfsContentPackage.DirectoryEntries[0].FileName;
                    return fileName.Length >= 6 && fileName.Substring(0, 6) == "Career";
                case 0x454109DB:
                    fileName = Package.StfsContentPackage.DirectoryEntries[0].FileName;
                    return fileName.Length >= 6 && fileName.Substring(0, 6) == "Career";

                // Halo 3
                case 0x4D5307E6:

                // Halo 3: ODST
                case 0x4D530877:

                // Halo Reach
                case 0x4D53085B:
                    if (PackageContainsFile(Package, "variant"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.HReachMegaloEditor);
                        return true;
                    }
                    return PackageContainsFile(Package, "mmiof.bmf");

                // Halo 4
                case 0x4D530919:

                    if (PackageContainsFile(Package, "mmiof.bmf"))
                        metaIndex = FormIDToMetaIndex(FormID.Halo4CampaignEditor);
                    else if (PackageContainsFile(Package, "variant"))
                        metaIndex = FormIDToMetaIndex(FormID.H4MegaloEditor);
                    else
                        return false;

                    return true;

                // Metro 2033
                case 0x54510842:
                    return !PackageContainsFile(Package, "auto_save.save");

                // Forza 3
                case 0x4D53084D:
                    if (PackageContainsFile(Package, "ForzaProfile") && PackageContainsFile(Package, "PlayerDatabase"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.Forza3);
                        return true;
                    }

                    if (PackageContainsFile(Package, "thumb") && PackageContainsFile(Package, "metadata"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.Forza3SS);
                        return true;
                    }

                    if (PackageContainsFile(Package, "StorefrontID"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.Forza3Liveries);
                        return true;
                    }
                    return false;

                // Forza 4
                case 0x4D530910:
                    if (PackageContainsFile(Package, "ForzaProfile"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.Forza4Profile);
                        return true;
                    }
                    if (PackageContainsFile(Package, "thumb") && PackageContainsFile(Package, "metadata"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.Forza4Ss);
                        return true;
                    }
                    //else if (PackageContainsFile(Package, "DatabaseReservedName4001")|| PackageContainsFile(Package, "DatabaseReservedName4002") || PackageContainsFile(Package, "DatabaseReservedName4005"))
                    if(StfsPackageContainsFile(Package, "DatabaseReservedName*") || PackageContainsFile(Package, "StorefrontID"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.Forza4Livery);
                        return true;
                    }
                    return false;

                // NBA 2K13
                case 0x545408A2:
                    return StfsPackageContainsFile(Package, "*.CMG");
                // NBA 2K14
                case 0x545408B0:
                    return StfsPackageContainsFile(Package, "*.CMG");
                // NBA 2K15
                case 0x545408B5:
                    return StfsPackageContainsFile(Package, "*.CMG");

                // MLB 2K13
                case 0x545408AB:
                    return StfsPackageContainsFile(Package, "*.CMG");

                // Foza Horizon
                case 0x4D5309C9:
                    if (PackageContainsFile(Package, "ForzaProfile"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.ForzaHorizonProfile);
                        return true;
                    }
                    if (PackageContainsFile(Package, "thumb") && PackageContainsFile(Package, "metadata"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.ForzaHorizonSS);
                        return true;
                    }
                    if (StfsPackageContainsFile(Package, "DatabaseReservedName*") || PackageContainsFile(Package, "StorefrontID"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.ForzaHorizonLivery);
                        return true;
                    }
                    return false;
                // Foza Horizon 2 
                case 0x4D530AA4:
                    if (PackageContainsFile(Package, "ForzaProfile"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.ForzaHorizon2Profile);
                        return true;
                    }
                    if (PackageContainsFile(Package, "thumb") && PackageContainsFile(Package, "metadata"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.ForzaHorizonSS);
                        return true;
                    }
                    if (StfsPackageContainsFile(Package, "DatabaseReservedName*") || PackageContainsFile(Package, "StorefrontID"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.ForzaHorizonLivery);
                        return true;
                    }
                    return false;
                // Alice: Madness Returns
                case 0x45410916:
                    return PackageContainsFile(Package, "Alice2Checkpoint.sav");

                // Gears of War 3
                case 0x4D5308AB:
                    if (PackageContainsFile(Package, "GearsCheckpoint0.sav"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.GearsOfWar3);
                        return true;
                    }
                    if (PackageContainsFile(Package, "PlayerStorage.dat"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.GearsOfWar3PlayerData);
                        return true;
                    }
                    return false;

                // Gears of War: Judgment
                case 0x4D530A26:
                    if (PackageContainsFile(Package, "GearsCheckpoint0.sav"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.GearsOfWarJudgment);
                        return true;
                    }
                    if (PackageContainsFile(Package, "PlayerStorage.dat"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.GearsOfWarJudgmentStatsEditor);
                        return true;
                    }
                    return false;

                // Modern Warfare 3
                case 0x415608CB:
                    if (PackageContainsFile(Package, "savegame.svg"))
                    {
                        metaIndex = FormIDToMetaIndex(FormID.MW3CampaignSave);
                        return true;
                    }
                    return false;

                case 0x4541096D:
                    return StfsPackageContainsFile(Package, "ssxvprofile*");

                // Other screwed up titles
                case 0:
                    return false;

                default:
                    return true;
            }
        }

        private static bool PackageContainsFile(XContentPackage Package, string fileName)
        {
            for (int x = 0; x < Package.StfsContentPackage.DirectoryEntries.Count; x++)
                if (!Package.StfsContentPackage.DirectoryEntries[x].IsDirectory
                    && Package.StfsContentPackage.DirectoryEntries[x].FileName == fileName)
                    return true;
            return false;
        }
        private static bool StfsPackageContainsFile(XContentPackage Package, string fileName)
        {
            return Package.StfsContentPackage.FileExists(fileName);
        }
        private static bool PackageContainsFilename(XContentPackage Package, string fileName)
        {
            for (int x = 0; x < Package.StfsContentPackage.DirectoryEntries.Count; x++)
                if (!Package.StfsContentPackage.DirectoryEntries[x].IsDirectory
                    && Package.StfsContentPackage.DirectoryEntries[x].FileName == fileName)
                    return true;
            return false;
        }
        internal static uint GetProperTitleID(XContentPackage Package)
        {
            uint titleId = Package.Header.Metadata.ExecutionId.TitleId;
            if (titleId != 0)
            {
                if (titleId == 0x45410959)
                    return 0x454108DF;

                return titleId;
            }
            switch (Package.Header.Metadata.TitleName)
            {
                case "FIFA 11":
                    return 0x454108F3;
                case "FIFA 12":
                    return 0x45410967;
                case "FIFA 13":
                    return 0x45410998;
                case "FIFA 14":
                    return 0x454109C3;
                case "FIFA 15":
                    return 0x454109DB;
                case "Fable II":
                    return 0x4D5307F1;
                case "Fable III":
                    return 0x4D5308D6;
                case "NHL® 12":
                    return 0x45410964;
                case "SSX™":
                    return 0x4541096D;
            }
            return 0;
        }
    }
}
